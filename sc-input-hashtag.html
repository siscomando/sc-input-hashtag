<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../font-roboto/roboto.html">
<link rel="import" href="../paper-elements/paper-elements.html">
<link rel="import" href="../core-icon/core-icon.html">
<link rel="import" href="../core-a11y-keys/core-a11y-keys.html">

<!--
sc-input-hashtag a smart input that automagically change hashtag typed by links

##### Example

    <sc-input-hashtag url="/hashtags/generator"></sc-input-hashtag>

@element sc-input-hashtag
@blurb Element providing a smart input that change hashtag typed by links
@status alpha
@homepage http://github.com/siscomando/sc-input-hashtag
-->
<polymer-element name="sc-input-hashtag" attributes="notitle author url method">

  <template>
    <link rel="stylesheet" href="sc-input-hashtag.css">
    <core-ajax id="coreAjaxInput"
    url="{{url}}" handleAs="json"
    response="{{response}}"
    method="{{ method ? method : 'POST'}}"
    contentType="application/json"
    >
    </core-ajax>

    <div id="inputComments">
      <form id="commentForm">
        <paper-icon-button id="btnComment" icon="communication:chat"></paper-icon-button>
        <paper-input-decorator raised="true" label="VocÃª tem ideias para resolver problemas...?">
          <input id="comment" is="core-input" name="c"  value="" autocorrect="off" autocomplete="off" />
          <core-a11y-keys target="{{}}" keys="Enter" on-keys-pressed="{{sendTo}}"></core-a11y-keys>
          <input hidden="true" type="submit" />
        </paper-input-decorator>       
      </form>
    </div>    

  </template>

  <script>

    Polymer({     
      /**
       * The `author` attribute sets an initial author
       *
       * @attribute author
       * @type string
       * @default 'Horacio Ibrahim'
       */
      author: 'Horacio Ibrahim', 
      publish: {
          displaySearch: {value: false, reflect: true}, 
          register: null, 
      },
      /* the best place to the constructor for array or object */
      created: function() {
        // initialize but it not is turned public to use by users of the element
        // to turn public to use attributes or publish.
      },
      ready: function() {
        // Ready is a lifecycle callback.
        // You can do setup work in here.
        // More info: http://www.polymer-project.org/docs/polymer/polymer.html#lifecyclemethods
        // simple test alert(this.issueInfo.register);
        // var scnavbar = document.querySelector('sc-navbar');
        var inputHashtag = this;
        this.changeParamRegister(document, 'sc-select', inputHashtag);        
      },
      sendTo: function(){
          var ajax = this.$.coreAjaxInput;
          var data = {};
          var dataUser = JSON.parse(window.localStorage.getItem('User'));
          data['body'] = this.$.comment.value;  
          data['register'] = this.register;  
          data['author'] = dataUser['pk']; // TODO: fix it
          if (this.$.comment.value.length > 0) {
            ajax.body = JSON.stringify(data);  
            ajax.go();
            this.$.commentForm.reset();
          }
      },
      responseChanged: function() {
        // clean the input if all right
          this.fire('sc-sse-response', {response: this.response, alias: 'sseTimeline'});
      },
      /**
       * The `changeParamRegister` change to current Register
       *
       * 
       * @method changeParamRegister
       * @param source an instance that generated the event
       * @param eventName the name of the event generated by source 
       * @param callback a callback or this custom element
       */       
      changeParamRegister: function(source, eventName, callback) {
        source.addEventListener(eventName, function(e){
              register = e.detail.issue;
              register = register.replace('/', '');
              callback.register = register;
        });
      }       
    });

  </script>

</polymer-element>
